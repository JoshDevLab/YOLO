<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="josh">

	<select id="searchJoinUserList" parameterType="String" resultType="com.yolo.hr.josh.model.MemberVO">
		select email, name from tbl_employees
		where lower(name) like '%'||lower(#{joinuser})||'%'
	</select>

	<insert id="insertSchedule" parameterType="com.yolo.hr.josh.model.ScheduleVO">
		insert into tbl_schedule(schedule_no, fk_empno, start_date, end_date, subject, content, color, category, fk_deptno, joinuser, place)
		values(seq_scheduleno.nextval, #{fk_empno}, to_date(#{start_date},'YYYY-MM-DD HH24:MI:SS'), to_date(#{end_date},'YYYY-MM-DD HH24:MI:SS'), #{subject}, #{content}, #{color}, #{category}, #{fk_deptno}, #{joinuser}, #{place})
	</insert>

	<select id="selectScheduleList" resultType="com.yolo.hr.josh.model.ScheduleVO">
		select schedule_no,fk_empno
		      ,to_char(start_date,'yyyy-mm-dd hh24:mi') as start_date
		      ,to_char(end_date,'yyyy-mm-dd hh24:mi') as end_date
		      ,subject,content,color,category,fk_deptno,joinuser,place
		from tbl_schedule
	</select>
	
	<select id="selectDetailSchedule" parameterType="String" resultType="com.yolo.hr.josh.model.ScheduleVO">
		select schedule_no,fk_empno
		      ,to_char(start_date,'yyyy-mm-dd hh24:mi') as start_date
		      ,to_char(end_date,'yyyy-mm-dd hh24:mi') as end_date
		      ,subject,content,color,category,fk_deptno,joinuser,place
		from tbl_schedule
		where schedule_no = #{schedule_no}
	</select>
	
	<update id="updateSchedule" parameterType="com.yolo.hr.josh.model.ScheduleVO">
		update tbl_schedule set start_date = to_date(#{start_date},'YYYY-MM-DD HH24:MI:SS')
							   ,end_date = to_date(#{end_date},'YYYY-MM-DD HH24:MI:SS')
							   ,subject = #{subject}
							   ,content = #{content} 
							   ,color = #{color}
							   ,joinuser = #{joinuser}
							   ,category = #{category}
							   ,place = #{place}
		where schedule_no = #{schedule_no}
	</update>
	
	<delete id="deleteSchedule" parameterType="String">
		delete from tbl_schedule where schedule_no = #{schedule_no}
	</delete>
	
	<insert id="commuteStart" parameterType="String">
		insert into tbl_commute(fk_empno, start_work_time, end_work_time, worktime, overtime)
		values(#{fk_empno}, sysdate, null, null, null)
	</insert>
	
	<select id="checkCommute" parameterType="String" resultType="com.yolo.hr.josh.model.CommuteVO">
		select  fk_empno 
		       , to_char(start_work_time,'yyyy-mm-dd hh24:mi:ss') as start_work_time
		       , end_work_time, worktime, overtime 
		from tbl_commute 
		where to_char(start_work_time,'yyyy-mm-dd') = to_char(sysdate, 'yyyy-mm-dd') 
		      and fk_empno = #{fk_empno}
	</select>
	
	<update id="commuteEnd" parameterType="Map">
		update tbl_commute set end_work_time = sysdate,
                       		   worktime = '${worktime}',
                       		   overtime = '${overtime}'
		where to_char(start_work_time,'yyyy-mm-dd') = to_char(sysdate, 'yyyy-mm-dd') 
		      and fk_empno = '${fk_empno}'	
	</update>
	
	
	<select id="mycommute" parameterType="HashMap" resultType="com.yolo.hr.josh.model.CommuteVO">
		select dt, nvl(fk_empno,'${fk_empno}') AS fk_empno 
		       , nvl2(start_work_time,to_char(start_work_time,'yyyy-mm-dd hh24:mi'),'X') as start_work_time
		       , nvl2(end_work_time,to_char(end_work_time,'yyyy-mm-dd hh24:mi'),'X') as end_work_time
		       , nvl(worktime,0) AS worktime
		       , nvl(overtime,0) AS overtime 
		from 
		(
		select * 
		from tbl_commute 
		where fk_empno = '${fk_empno}'
		)c
		right join 
		(
		SELECT TO_CHAR(TO_DATE('${startdate}','YYYY-MM-DD') + LEVEL - 1, 'YYYY-MM-DD') AS dt
		  FROM dual 
		  CONNECT BY LEVEL <![CDATA[<=]]> (TO_DATE('${enddate}','YYYY-MM-DD')   
		                                 - TO_DATE('${startdate}','YYYY-MM-DD') + 1) 
		) d
		on to_char(c.start_work_time,'yyyy-mm-dd') = d.dt
		order by dt asc
	</select>
	
	<resultMap type="HashMap" id="selectDeptMap">
		<result property="level" 	column="level" 		javaType="String"/>
		<result property="deptname" 	column="deptname" 		javaType="String"/>
		<result property="deptno" 	column="deptno" 		javaType="String"/>
	</resultMap>
	
	<select id="selectDept" resultMap="selectDeptMap">
		select
		level 
		,LPAD(' ',(LEVEL-1)*2)||deptname AS deptname
		,deptno
		from tbl_dept
		start with upper_deptno=1
		connect by prior deptno = upper_deptno
	</select>
	
</mapper>
