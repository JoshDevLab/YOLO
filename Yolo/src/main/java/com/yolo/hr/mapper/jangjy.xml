<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="jangjy">
	<!-- 아이디와 비밀번호를 입력받아 select -->
	<select id="checkLogin" resultType="com.yolo.hr.jjy.employee.model.EmployeeVO" parameterType="HashMap">
		select empno, name, lastname, firstname, email
			  ,pwd, mobile, hiredate, retiredate
			  ,fk_deptno,time_salary, rrn, position
			  ,address, account, introduce
			  ,status, profile_color
		from tbl_employees
		where email = #{email} and pwd = #{pwd}
	</select>
	
	<resultMap type="HashMap" id="EmployeeList_Map">
		<result property="empno"     				column="empno"    				 javaType="String"/>
		<result property="name"          			column="name"         			 javaType="String"/>
		<result property="lastname" 				column="lastname"   			 javaType="String"/>
		<result property="firstname"           		column="firstname"             	 javaType="String"/>
		<result property="email" 		   			column="email"              	 javaType="String"/>
		<result property="pwd" 		   				column="pwd"              		 javaType="String"/>
		<result property="mobile" 		   			column="mobile"                  javaType="String"/>
		<result property="hiredate" 		   		column="hiredate"                javaType="String"/>
		<result property="retiredate" 		 	    column="retiredate"              javaType="String"/>
		<result property="fk_deptno" 		   		column="fk_deptno"               javaType="String"/>
		<result property="time_salary" 		   		column="time_salary"             javaType="String"/>
		<result property="rrn" 		     			column="rrn"              		 javaType="String"/>
		<result property="position" 		        column="position"              	 javaType="String"/>
		<result property="continuousServiceMonth"   column="continuousServiceMonth"  javaType="String"/>
		<result property="workingDays" 		        column="workingDays"             javaType="String"/>
		<result property="address" 		   			column="address"              	 javaType="String"/>
		<result property="account" 		   			column="account"              	 javaType="String"/>
		<result property="introduce" 		   		column="introduce"               javaType="String"/>
		<result property="status" 		   			column="status"              	 javaType="String"/>
		<result property="profile_color" 		   	column="profile_color"           javaType="String"/>
		<result property="gender" 		   			column="gender"              	 javaType="String"/>
		<result property="deptname" 		   		column="deptname"                javaType="String"/>
	</resultMap>
	
	
	<!-- 모든 사원의 정보를 조회하기  -->
	<select id="getEmpList" resultMap="EmployeeList_Map" parameterType="HashMap">
		select empno, name, lastname, firstname, email
		      ,pwd, mobile, to_char(hiredate,'yyyy.mm.dd') as hiredate
		      , nvl(to_char(retiredate,'yyyy.mm.dd'),' ') as retiredate
		      ,fk_deptno,time_salary, rrn, position
		      , trunc(MONTHS_BETWEEN(sysdate, hiredate),0)|| '개월' as continuousServiceMonth
		      , trunc(sysdate - hiredate,0) as workingDays
		      ,address, account, introduce
		      ,status, profile_color
		      ,func_gender(rrn) as gender
		      ,deptname
		from tbl_employees E left join TBL_DEPT D
		on E.fk_deptno = d.deptno
	</select>
	
	<resultMap type="HashMap" id="EmployeeMap">
		<result property="empno"     				column="empno"    				 javaType="String"/>
		<result property="name"          			column="name"         			 javaType="String"/>
		<result property="profileName"          	column="profileName"         	 javaType="String"/>
		<result property="englishName" 				column="englishName"   			 javaType="String"/>
		<result property="email" 		   			column="email"              	 javaType="String"/>
		<result property="mobile" 		   			column="mobile"                  javaType="String"/>
		<result property="hiredate" 		   		column="hiredate"                javaType="String"/>
		<result property="retiredate" 		 	    column="retiredate"              javaType="String"/>
		<result property="fk_deptno" 		   		column="fk_deptno"               javaType="String"/>
		<result property="time_salary" 		   		column="time_salary"             javaType="String"/>
		<result property="position" 		        column="position"              	 javaType="String"/>
		<result property="rrn" 		     			column="rrn"              		 javaType="String"/>
		<result property="continuousServiceMonth"   column="continuousServiceMonth"  javaType="String"/>
		<result property="workingDays" 		        column="workingDays"             javaType="String"/>
		<result property="address" 		   			column="address"              	 javaType="String"/>
		<result property="account" 		   			column="account"              	 javaType="String"/>
		<result property="introduce" 		   		column="introduce"               javaType="String"/>
		<result property="status" 		   			column="status"              	 javaType="String"/>
		<result property="profile_color" 		   	column="profile_color"           javaType="String"/>
		<result property="gender" 		   			column="gender"              	 javaType="String"/>
		<result property="birthday" 		   		column="birthday"              	 javaType="String"/>
		<result property="teamname" 		   		column="teamname"                javaType="String"/>
		<result property="deptname" 		   		column="deptname"                javaType="String"/>
	</resultMap>
	
	<!-- 사원 번호를 전달받아 사원 정보 조회하기  -->
	<select id="getEmpOne" resultMap="EmployeeMap" parameterType="HashMap">
		select empno , name , firstname ||' '|| lastname as englishName
			 , substr(name,2) as profileName
		     , email , substr(mobile,1,3) || '-' || substr(mobile,4,4)|| '-' || substr(mobile,8,4) as mobile
		     , to_char(hiredate,'yyyy.mm.dd') as hiredate
		     , nvl(to_char(retiredate,'yyyy.mm.dd'),' ') as retiredate
		     , fk_deptno , time_salary , position
		     , substr(rrn,1,6) || '-' ||substr(rrn,7) as rrn
		     , trunc(MONTHS_BETWEEN(sysdate, hiredate),0)|| '개월' as continuousServiceMonth
		     , trunc(sysdate - hiredate,0) as workingDays
		     , address , account , introduce , status , profile_color
		     ,func_gender(rrn) as gender
		     ,func_birthday(rrn) as birthday
		     ,D1.deptname as teamname
		     ,D2.deptname as deptname
		from tbl_employees E left join TBL_DEPT D1
		on E.fk_deptno = D1.deptno
		left join tbl_dept D2
		on D1.upper_deptno = D2.deptno
		where empno = #{empno}
	</select>
	
	
	<!-- 시작일, 종료일, 사원번호, 메모, 사원번호를 Map 으로 전달받아 휴직테이블에 insert  -->
	<insert id="insertLeave" parameterType="HashMap" >
		insert into tbl_leave(leaveno,fk_empno, leavetype, startdate, enddate, memo)
		values(seq_leaveno.nextval, #{empno}, #{leavetype}, #{startdate}, #{enddate}, #{memo})
	</insert>
	
	<!--  사원 번호를 입력받아 휴직 처리 (update) -->
	<update id="updateLeave" parameterType="HashMap">
		update tbl_employees set status  = '휴직'
		where empno  = #{empno}
	</update>
	
	
	<!-- 재직 처리해야하는 사원 목록 조회하기  -->
	<resultMap type="HashMap" id="leaveEmpMap">
		<result property="empno"   column="empno"   javaType="String"/>
	</resultMap>
	
	<!-- 재직처리해야하는 회원 조회하기 -->
	<select id="getLeaveEmpList" resultMap="leaveEmpMap">
		select empno
		from tbl_employees E join tbl_leave L
		on E.empno = L.fk_empno
		where E.status ='휴직'
		and to_char(sysdate, 'yyyy-mm-dd') > to_char(enddate,'yyyy-mm-dd')
		
	</select>
	
	<!-- 휴직이 끝난 사원 재직 처리하기 (update) -->
	<update id="updateLeaveEmp" parameterType="HashMap">
		update tbl_employees set status  = '재직'
		where empno in
    	<foreach collection="arr_leaveEmp" index="i" open="(" separator="," close=")">
			'${arr_leaveEmp[i]}'
		</foreach>	
	</update>
	
	
	
	
	
	
	
	
	<!-- ====================== 조직도 =================== -->
	<!-- 모든 부서 정보 조회하기 -->
	<resultMap type="HashMap" id="deptNameList_Map">
		<result property="deptno"       column="deptno"    	   javaType="String"/>
		<result property="deptname"     column="deptname"      javaType="String"/>
		<result property="upper_deptno"	column="upper_deptno"  javaType="String"/>
	</resultMap>

	<select id="deptName" resultMap="deptNameList_Map">
		select deptno , deptname, upper_deptno
		from tbl_dept 
		where upper_deptno = 1
	</select>
	
	
	<!-- 부서번호를 전달받아 팀목록 조회하기 -->
	<resultMap type="HashMap" id="teamNameList_Map">
		<result property="deptno"       column="deptno"    	   javaType="String"/>
		<result property="deptname"     column="deptname"      javaType="String"/>
		<result property="upper_deptno"	column="upper_deptno"  javaType="String"/>
	</resultMap>

	<select id="getTeamName" resultMap="teamNameList_Map" parameterType="HashMap">
		select deptno, deptname, upper_deptno
		from tbl_dept
		where upper_deptno = #{deptno}
	</select>
	
	
	<!-- 팀 번호를 전달받아 해당 팀에 속하는 사원 조회하기  -->
	<resultMap type="HashMap" id="employeeList_Map">
		<result property="deptname"   column="deptname"  javaType="String"/>
		<result property="name"       column="name"    	 javaType="String"/>
	</resultMap>

	<select id="getEmployees" resultMap="employeeList_Map" parameterType="HashMap">
		select deptname, name
		from tbl_employees E JOIN tbl_dept D
		on E.fk_deptno = D.deptno
		where fk_deptno = #{teamno}
	</select>
	<!-- ====================== 조직도 =================== -->


</mapper>



